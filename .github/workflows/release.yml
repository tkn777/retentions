name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # Checkout including tags
      # -----------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      # -----------------------------------------------------------
      # Install system tools + Python deps + gh
      # -----------------------------------------------------------
      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y alien dpkg-dev python3-pip gh

      - name: Install Python dependencies
        run: |
          PYVER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          echo "PYTHONPATH=$HOME/.local/lib/python${PYVER}/site-packages" >> $GITHUB_ENV

      # -----------------------------------------------------------
      # Build artifacts via release script
      # -----------------------------------------------------------
      - name: Run release.sh
        run: bash release/release.sh "${GITHUB_REF_NAME#v}"

      # -----------------------------------------------------------
      # Detect prerelease
      # -----------------------------------------------------------
      - name: Detect prerelease
        id: pre
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ -(alpha|beta|rc)[0-9]*$ ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
          else
            echo "pre=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------
      # Determine previous tag for changelog
      # -----------------------------------------------------------
      - name: Get previous tag
        id: prev
        run: |
          CUR="${GITHUB_REF_NAME}"
          PREV=""

          while read -r tag; do
            if [ "$tag" = "$CUR" ]; then
              break
            fi
            PREV="$tag"
          done < <(git tag --sort=creatordate)

          echo "tag=$PREV" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # Generate release body (Official Artifacts + Changelog)
      # -----------------------------------------------------------
      - name: Generate release body
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          TAG="${GITHUB_REF_NAME}"
          PREV="${{ steps.prev.outputs.tag }}"
          REPO="${GITHUB_REPOSITORY}"

          echo "Assembling release notesâ€¦"

          DEB=$(ls build/retentions_*_all.deb 2>/dev/null || true)
          RPM=$(ls build/retentions-*.rpm 2>/dev/null || true)
          TAR=$(ls build/retentions-*.tar.gz)
          ZIP=$(ls build/retentions-*.zip)
          SCRIPT=$(ls build/retentions.py 2>/dev/null || true)

          add_link() {
            local f="$1"
            [ -z "$f" ] && return
            local name url
            name=$(basename "$f")
            url="https://github.com/${REPO}/releases/download/${TAG}/${name}"
            echo "- ðŸ“¦ [${name}](${url})"
          }

          {
            echo "## Official Release Artifacts"
            echo
            echo "### Linux"
            echo
            for f in $DEB $RPM; do
              add_link "$f"
            done
            echo
            echo "### Common (cross-platform)"
            echo
            for f in $TAR $ZIP; do
              add_link "$f"
            done
            echo
            echo "### Just the script"
            echo
            if [ -n "$SCRIPT" ]; then
              add_link "$SCRIPT"
            fi
            echo

            if [ -n "$PREV" ]; then
              echo "## Changelog since ${PREV}"
              echo
              git log --pretty=format:'- [`%h`](https://github.com/'"${REPO}"'/commit/%h) %s' "${PREV}..${TAG}"
            else
              echo "## Changelog"
              echo
              echo "- Initial release"
            fi
          } > release_body.md

      # -----------------------------------------------------------
      # Create GitHub release via gh
      # -----------------------------------------------------------
      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          TITLE="Retentions ${GITHUB_REF_NAME}"

          FLAGS=()
          if [[ "${{ steps.pre.outputs.pre }}" == "true" ]]; then
            FLAGS+=(--prerelease)
          fi

          # Debug: show build contents
          echo "==> Build directory:"
          ls -R build

          gh release create "$TAG" \
            build/retentions-*.tar.gz \
            build/retentions-*.zip \
            build/retentions_*.deb \
            build/retentions-*.rpm \
            build/retentions.py \
            --title "$TITLE" \
            --notes-file release_body.md \
            "${FLAGS[@]}"
