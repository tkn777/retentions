name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # Install system tools + Python deps
      # -----------------------------------------------------------
      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y alien dpkg-dev python3-pip

      - name: Install Python dependencies
        run: |
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user shtab shlib
          PYVER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          echo "PYTHONPATH=$HOME/.local/lib/python${PYVER}/site-packages" >> $GITHUB_ENV

      # -----------------------------------------------------------
      # Build Release Files
      # -----------------------------------------------------------
      - name: Run release.sh
        run: bash release/release.sh "${GITHUB_REF_NAME#v}"

      # -----------------------------------------------------------
      # Determine pre-release flag
      # -----------------------------------------------------------
      - name: Detect prerelease
        id: pre
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ -(alpha|beta|rc)[0-9]*$ ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
          else
            echo "pre=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------
      # Determine previous tag for changelog
      # -----------------------------------------------------------
      - name: Get previous tag
        id: prev
        run: |
          PREV=$(git describe --tags --abbrev=0 HEAD^ || echo "")
          echo "tag=$PREV" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Build multiline release body text
      # -----------------------------------------------------------
      - name: Generate release body
        id: body
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PREV="${{ steps.prev.outputs.tag }}"

          echo "Assembling release notesâ€¦"

          LINUX=$(ls build/retentions_*_all.deb 2>/dev/null || true)
          RPM=$(ls build/retentions-*.rpm 2>/dev/null || true)
          TAR=$(ls build/retentions-*.tar.gz)
          ZIP=$(ls build/retentions-*.zip)
          SCRIPT=$(ls build/retentions.py)

          BODY="# Retentions ${VERSION}\n"
          BODY+="\n## Official Release Artifacts\n"

          BODY+="\n### Linux\n"
          for f in $LINUX $RPM; do
            BODY+="ðŸ“¦ $(basename "$f")\n"
          done

          BODY+="\n### Common\n"
          for f in $TAR $ZIP; do
            BODY+="ðŸ“¦ $(basename "$f")\n"
          done

          BODY+="\n### Just the script\n"
          BODY+="ðŸ“¦ $(basename "$SCRIPT")\n"

          # -------------------------
          # Changelog
          # -------------------------
          if [[ -n "$PREV" ]]; then
            CHANGELOG=$(git log --pretty=format:'- %s' "$PREV"..HEAD)
            BODY+="\n## Changelog since ${PREV}\n\n${CHANGELOG}\n"
          else
            BODY+="\n## Changelog\n\n- Initial release\n"
          fi

          # Write multi-line output safely
          {
            echo "markdown<<EOF"
            echo -e "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Step 1 â€” Create empty release (NO ASSETS YET!)
      # -----------------------------------------------------------
      - name: Create empty GitHub release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Retentions ${{ github.ref_name }}"
          draft: false
          prerelease: ${{ steps.pre.outputs.pre }}
          body: ""
          make_latest: true

      # -----------------------------------------------------------
      # Step 2 â€” Upload assets
      # -----------------------------------------------------------
      - name: Upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            build/retentions-*.tar.gz
            build/retentions-*.zip
            build/retentions_*.deb
            build/retentions-*.rpm
            build/retentions.py

      # -----------------------------------------------------------
      # Step 3 â€” Update release body (after assets exist)
      # -----------------------------------------------------------
      - name: Update release notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.body.outputs.markdown }}
