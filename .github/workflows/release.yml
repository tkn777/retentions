name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # Install system tools + Python deps + gh
      # -----------------------------------------------------------
      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y alien dpkg-dev python3-pip gh

      - name: Install Python dependencies
        run: |
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user shtab shlib
          PYVER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          echo "PYTHONPATH=$HOME/.local/lib/python${PYVER}/site-packages" >> $GITHUB_ENV

      # -----------------------------------------------------------
      # Build artifacts via your release script
      # -----------------------------------------------------------
      - name: Run release.sh
        run: bash release/release.sh "${GITHUB_REF_NAME#v}"

      # -----------------------------------------------------------
      # Detect prerelease
      # -----------------------------------------------------------
      - name: Detect prerelease
        id: pre
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ -(alpha|beta|rc)[0-9]*$ ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
          else
            echo "pre=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------
      # Determine previous tag for changelog
      # -----------------------------------------------------------
      - name: Get previous tag
        id: prev
        run: |
          PREV=$(git describe --tags --abbrev=0 HEAD^ || echo "")
          echo "tag=$PREV" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Generate release body (Official Artifacts + Changelog)
      # -----------------------------------------------------------
      - name: Generate release body
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PREV="${{ steps.prev.outputs.tag }}"

          echo "Assembling release notesâ€¦"

          LINUX=$(ls build/retentions_*_all.deb 2>/dev/null || true)
          RPM=$(ls build/retentions-*.rpm 2>/dev/null || true)
          TAR=$(ls build/retentions-*.tar.gz)
          ZIP=$(ls build/retentions-*.zip)
          SCRIPT=$(ls build/retentions.py 2>/dev/null || true)

          {
            echo "Retentions ${VERSION}"
            echo
            echo "Official Release Artifacts"
            echo
            echo "Linux"
            echo
            for f in $LINUX $RPM; do
              [ -n "$f" ] && echo "    ðŸ“¦ $(basename "$f")"
            done
            echo
            echo "Common"
            echo
            for f in $TAR $ZIP; do
              [ -n "$f" ] && echo "    ðŸ“¦ $(basename "$f")"
            done
            echo
            echo "Just the script"
            echo
            if [ -n "$SCRIPT" ]; then
              echo "    ðŸ“¦ $(basename "$SCRIPT")"
            fi

            echo
            if [[ -n "$PREV" ]]; then
              echo "Changelog since ${PREV}"
              echo
              git log --pretty=format:'- %s' "$PREV"..HEAD
            else
              echo "Changelog"
              echo
              echo "- Initial release"
            fi
          } > release_body.md

      # -----------------------------------------------------------
      # Create GitHub release via gh
      # -----------------------------------------------------------
      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          TITLE="Retentions ${GITHUB_REF_NAME}"

          FLAGS=()
          if [[ "${{ steps.pre.outputs.pre }}" == "true" ]]; then
            FLAGS+=(--prerelease)
          fi

          # Debug: show build contents
          echo "==> Build directory:"
          ls -R build

          gh release create "$TAG" \
            build/retentions-*.tar.gz \
            build/retentions-*.zip \
            build/retentions_*.deb \
            build/retentions-*.rpm \
            build/retentions.py \
            --title "$TITLE" \
            --notes-file release_body.md \
            "${FLAGS[@]}"
